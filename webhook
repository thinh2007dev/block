-- Webhook Blocker v3.0 - CH·ªà BLOCK WEBHOOK
-- Kh√¥ng ƒë·ªông v√†o HTTP services kh√°c c·ªßa game
-- Safe cho m·ªçi game/hub

if getgenv().WEBHOOK_BLOCKER_V3_LOADED then
    return
end

getgenv().WEBHOOK_BLOCKER_V3_LOADED = true

local ENABLE_LOGS = false

local function log(...)
    if ENABLE_LOGS then
        print('[WH Block]', ...)
    end
end

log('Kh·ªüi ƒë·ªông Webhook Blocker v3.0 (Safe Mode)...')

-- CH·ªà BLOCK NH·ªÆNG DOMAIN N√ÄY (webhook th·ª±c s·ª±)
local webhook_domains = {
    "discord.com/api/webhooks",
    "discordapp.com/api/webhooks",
    "discord.gg/api/webhooks",
    "hooks.slack.com/services",
    "hooks.slack.com/workflows"
}

-- H√†m check CH√çNH X√ÅC webhook (strict mode)
local function is_webhook_strict(url)
    if not url or type(url) ~= "string" then
        return false
    end
    
    local url_lower = url:lower()
    
    -- CH·ªà BLOCK N·∫æU MATCH CH√çNH X√ÅC
    for _, domain in ipairs(webhook_domains) do
        if url_lower:find(domain, 1, true) then -- true = plain text search
            return true
        end
    end
    
    return false
end

-- ========== CH·ªà HOOK REQUEST FUNCTIONS (KH√îNG ƒê·ªòNG V√ÄO GAME HTTP) ==========
local function hook_request_only()
    local original_request = request or http_request or (http and http.request) or (syn and syn.request)
    
    if not original_request then
        log('Kh√¥ng t√¨m th·∫•y request function')
        return
    end
    
    local function safe_request(options)
        -- CH·ªà CHECK request function, KH√îNG CHECK game:HttpGet
        if type(options) == "table" and options.Url then
            if is_webhook_strict(options.Url) then
                warn('[Webhook Block] üõë Ch·∫∑n:', options.Url)
                
                -- Tr·∫£ v·ªÅ response gi·∫£ ƒë·ªÉ kh√¥ng crash
                return {
                    Success = true,
                    StatusCode = 200,
                    StatusMessage = "OK",
                    Body = '{"success":true,"blocked":true}',
                    Headers = {
                        ["content-type"] = "application/json"
                    }
                }
            end
        end
        
        -- Kh√¥ng ph·∫£i webhook -> cho qua b√¨nh th∆∞·ªùng
        return original_request(options)
    end
    
    -- Override request functions
    if getgenv().request then
        getgenv().request = safe_request
    end
    if getgenv().http_request then
        getgenv().http_request = safe_request
    end
    if http and http.request then
        http.request = safe_request
    end
    if syn and syn.request then
        syn.request = safe_request
    end
    
    log('‚úì ƒê√£ hook request functions (safe mode)')
end

-- ========== HOOK WEBSOCKET (CH·ªà WEBHOOK WS) ==========
local function hook_websocket_only()
    if syn and syn.websocket and syn.websocket.connect then
        local original_ws = syn.websocket.connect
        
        syn.websocket.connect = function(url)
            if is_webhook_strict(url) then
                warn('[Webhook Block] üõë Ch·∫∑n WebSocket:', url)
                
                -- Mock websocket
                return {
                    Send = function() end,
                    Close = function() end,
                    OnMessage = {Connect = function() return {Disconnect = function() end} end},
                    OnClose = {Connect = function() return {Disconnect = function() end} end}
                }
            end
            
            return original_ws(url)
        end
        
        log('‚úì ƒê√£ hook WebSocket (safe mode)')
    end
end

-- ========== KH·ªûI T·∫†O (CH·ªà HOOK C√ÅI C·∫¶N) ==========
local success, err = pcall(function()
    hook_request_only()      -- Ch·ªâ hook request functions
    hook_websocket_only()    -- Ch·ªâ hook websocket
    
    -- KH√îNG HOOK:
    -- - game:HttpGet
    -- - game:HttpPost  
    -- - HttpService:GetAsync
    -- - HttpService:PostAsync
    -- - HttpService:RequestAsync
    -- V√¨ nh·ªØng c√°i n√†y game c·∫ßn d√πng!
end)

if success then
    log('‚úÖ Webhook Blocker v3.0 s·∫µn s√†ng (Safe Mode)')
    log('üõ°Ô∏è Ch·ªâ block Discord/Slack webhooks')
    log('‚úì Kh√¥ng ·∫£nh h∆∞·ªüng ƒë·∫øn HTTP services c·ªßa game')
else
    warn('[Webhook Block] ‚ùå L·ªói:', err)
end
